name: Supa-restore

on:
  push:
    branches: [ restore ]
  workflow_dispatch:

jobs:
  run_db_restore:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      supabase_db_url: ${{ secrets.SUPABASE_RESTORE_DB_URL }}

    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: Restore database dump to Supabase
        run: |
          PGPASSWORD=${{ secrets.SUPABASE_DB_PASSWORD }} psql -h ${{ secrets.SUPABASE_DB_URL }} -p ${{ secrets.SUPABASE_PORT }} -d ${{ secrets.SUPABASE_NAME }} -U ${{ secrets.SUPABASE_USER }} < schema.sql
          PGPASSWORD=${{ secrets.SUPABASE_DB_PASSWORD }} psql -h ${{ secrets.SUPABASE_DB_URL }} -p ${{ secrets.SUPABASE_PORT }} -d ${{ secrets.SUPABASE_NAME }} -U ${{ secrets.SUPABASE_USER }} < data.sql
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
